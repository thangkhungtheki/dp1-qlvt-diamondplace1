
<div class="container-fluid">
  <h1 class="h3 mb-3 text-gray-800">üìÖ B·∫£ng C√¥ng Vi·ªác ƒê·ªãnh K·ª≥</h1>

  <div class="card shadow mb-4">
    <div class="card-header py-3 bg-primary text-white d-flex justify-content-between">
  <h6 class="m-0 font-weight-bold">Danh s√°ch c√¥ng vi·ªác</h6>

  <div class="d-flex gap-2">
    <a href="/housetask/api/them" class="btn btn-light btn-sm">
      <i class="fas fa-plus"></i> Th√™m c√¥ng vi·ªác
    </a>

    <a href="/housetask/api/xuatexcel" class="btn btn-light btn-sm">
      <i class="fas fa-file-excel"></i> Xu·∫•t Excel
    </a>
  </div>
</div>

    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="dataTable" width="100%">
          <thead class="thead-dark">
            <tr class="text-center">
              <th>Thao t√°c</th>
              <th>Khu v·ª±c</th>
              <th>V·ªã tr√≠</th>
              <th>T√™n c√¥ng vi·ªác</th>
              <th>Th√°ng</th>
              <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
              <th>Ng√†y k·∫øt th√∫c</th>
              <th>S·ªë l·∫ßn l√†m</th>
              <th>Th·ªùi gian</th>
              <th>S·ªë ng√†y nh·∫Øc</th>
             
              <th>M√¥ t·∫£ CV</th>
          
              <th>L·ªãch s·ª≠ CV</th>
              <th>L·ªãch s·ª≠ ki·ªÉm tra</th>
            </tr>
          </thead>

          <tbody>
          <% if (data && data.length > 0) { %>
            <% data.forEach((cv) => { %>
              <tr>
                <td class="text-center">
                  <div class="btn-group" role="group">
                    <a href="/housetask/api/history/<%= cv._id %>" class="btn btn-sm btn-secondary" title="Xem l·ªãch s·ª≠">
                        <i class="fas fa-history"></i>
                    </a>

                    <button class="btn btn-sm btn-info" onclick="sua('<%= cv._id %>')" title="S·ª≠a">
                      <i class="fas fa-edit"></i>
                    </button>
                    
                    <button class="btn btn-sm btn-danger" onclick="xacNhanXoa('<%= cv._id %>')" title="X√≥a">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
                
                <td><%= cv.khuvuc %></td>
                <td><%= cv.vitri %></td>
                <td><%= cv.tencv %></td>
                <td><%= cv.congviectheothang %></td>
                <td><%= cv.ngaybatdau %></td>
                <td><%= cv.ngayketthuc %></td>
                <td class="text-center"><%= cv.solanlam %></td>
                <td><%= cv.thoigian %></td>
                <td class="text-center"><%= cv.songaynhacthongbao %></td>
                
                <td title="<%= cv.motacongviec %>" style="cursor: help;">
                  <%= cv.motacongviec %>
                </td>
              
                <td title="<%= cv.lichsucv %>" style="cursor: help;">
                  <%= cv.lichsucv ? cv.lichsucv.replace(/\n/g, '. ') : '' %>
                </td>

                <td title="<%= cv.lichsukiemtra %>" style="cursor: help;">
                  <%= cv.lichsukiemtra ? cv.lichsukiemtra.replace(/\n/g, '. ') : '' %>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="13" class="text-center text-muted">Ch∆∞a c√≥ c√¥ng vi·ªác n√†o ƒë∆∞·ª£c th√™m.</td>
            </tr>
          <% } %>
        </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal X√≥a -->
<div class="modal fade" id="modalXoa" tabindex="-1" role="dialog" aria-labelledby="modalXoaLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="modalXoaLabel">X√≥a c√¥ng vi·ªác</h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">√ó</span>
        </button>
      </div>
      <div class="modal-body">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác n√†y?</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
        <button class="btn btn-danger" id="btnXoaCv">X√≥a</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal S·ª≠a -->
<div class="modal fade" id="modalSua" tabindex="-1" role="dialog" aria-labelledby="modalSuaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="modalSuaCVLabel"><i class="fas fa-edit"></i> Ch·ªânh s·ª≠a c√¥ng vi·ªác ƒë·ªãnh k·ª≥</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">√ó</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="form-sua-cv" method="POST">

           <!-- ‚úÖ ·∫¢nh minh h·ªça -->
          <div class="form-group text-center">
            <img id="edit_preview_anh" src="" alt="·∫¢nh c√¥ng vi·ªác" 
                 style="display:none; max-width: 250px; border-radius: 5px; margin-bottom: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.2);">
          </div>

          <input type="hidden" id="idcv" name="_id">

          <!-- Khu v·ª±c -->
          <div class="form-group">
            <label for="edit_khuvuc"><strong>Khu v·ª±c</strong></label>
            <select class="form-control" id="edit_khuvuc" name="khuvuc" required>
              <option value="">-- Ch·ªçn khu v·ª±c --</option>
              <option value="sanhtiec">S·∫£nh</option>
              <option value="vanphong">VƒÉn Ph√≤ng</option>
              <option value="khungoai">Khu Ngo√†i</option>
              <option value="khutiepthuc">Khu Ti·∫øp Th·ª±c</option>
              <option value="toiletkhach">Toilet Kh√°ch</option>
              <option value="phongcodau">Ph√≤ng C√¥ D√¢u</option>
            </select>
          </div>

          <!-- V·ªã tr√≠ -->
          <div class="form-group">
            <label for="edit_vitri"><strong>V·ªã tr√≠</strong></label>
            <input type="text" class="form-control" id="edit_vitri" name="vitri" placeholder="Nh·∫≠p v·ªã tr√≠">
          </div>

          <!-- T√™n c√¥ng vi·ªác -->
          <div class="form-group">
            <label for="edit_tencv"><strong>T√™n c√¥ng vi·ªác</strong></label>
            <input type="text" class="form-control" id="edit_tencv" name="tencv" placeholder="Nh·∫≠p t√™n c√¥ng vi·ªác">
          </div>
                <!-- Theo th√°ng -->
          <div class="form-group">
            <label for="edit_congviectheothang"><strong>Theo Th√°ng</strong></label>
            <select class="form-control" id="edit_congviectheothang" name="edit_congviectheothang" required>
              <option value="">-- Ch·ªçn th√°ng --</option>
              <option value="0">Trong th√°ng</option>
              <option value="2">2 th√°ng</option>
              <option value="3">3 th√°ng</option>
              <option value="4">4 th√°ng</option>
              <option value="5">5 th√°ng</option>
              <option value="6">6 th√°ng</option>
            </select>
          </div>
          <!-- Ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c -->
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="edit_ngaybatdau"><strong>Ng√†y b·∫Øt ƒë·∫ßu</strong></label>
              <input type="date" class="form-control" id="edit_ngaybatdau" name="ngaybatdau">
            </div>
            <div class="form-group col-md-6">
              <label for="edit_ngayketthuc"><strong>Ng√†y k·∫øt th√∫c</strong></label>
              <input type="date" class="form-control" id="edit_ngayketthuc" name="ngayketthuc">
            </div>
          </div>

          <!-- S·ªë l·∫ßn l√†m -->
          <div class="form-group">
            <label for="edit_solanlam"><strong>S·ªë l·∫ßn l√†m</strong></label>
            <input type="number" class="form-control" id="edit_solanlam" name="solanlam">
          </div>

          <!-- Th·ªùi gian -->
          <div class="form-group">
            <label for="edit_thoigian"><strong>Th·ªùi gian</strong></label>
            <input type="text" class="form-control" id="edit_thoigian" name="thoigian" placeholder="VD: 08:00 - 10:00">
          </div>

          <!-- S·ªë ng√†y nh·∫Øc th√¥ng b√°o -->
          <div class="form-group">
            <label for="edit_songaynhacthongbao"><strong>S·ªë ng√†y nh·∫Øc th√¥ng b√°o</strong></label>
            <input type="number" class="form-control" id="edit_songaynhacthongbao" name="songaynhacthongbao">
          </div>
          <!-- M√¥ t·∫£ c√¥ng vi·ªác -->
          <div class="form-group">
            <label for="edit_motacongviec"><strong>M√¥ t·∫£ c√¥ng vi·ªác</strong></label>
            <textarea class="form-control" id="edit_motacongviec" name="motacongviec" rows="6"></textarea>
          </div>
          <!-- L·ªãch s·ª≠ c√¥ng vi·ªác -->
          <div class="form-group">
            <label for="edit_lichsucv"><strong>L·ªãch s·ª≠ c√¥ng vi·ªác</strong></label>
            <textarea class="form-control" id="edit_lichsucv" name="lichsucv" rows="5"></textarea>
          </div>
          <!-- L·ªãch s·ª≠ ki·ªÉm tra -->
          <div class="form-group">
            <label for="edit_lichsukiemtra"><strong>L·ªãch s·ª≠ ki·ªÉm tra</strong></label>
            <textarea class="form-control" id="edit_lichsukiemtra" name="lichsukiemtra" rows="4"></textarea>
          </div>
          <div class="text-center">
            <button type="submit" class="btn btn-warning text-white px-4">C·∫≠p nh·∫≠t</button>
            <button type="button" class="btn btn-secondary px-4 ml-2" data-dismiss="modal">ƒê√≥ng</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- jQuery -->
<script src="/vendor/jquery/jquery.min.js"></script>

<!-- Bootstrap core JavaScript -->
<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Core plugin JavaScript -->
<script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- DataTables -->
<script src="/vendor/datatables/jquery.dataTables.min.js"></script>
<script src="/vendor/datatables/dataTables.bootstrap4.min.js"></script>

<!-- Custom scripts -->
<script src="/js/sb-admin-2.min.js"></script>

<!-- Kh·ªüi t·∫°o DataTable -->
<script>

  // Kh·ªüi t·∫°o b·∫£ng DataTable
  // $(document).ready(function() {
  //   $.noConflict();
  //   var table = $('#dataTable').DataTable({
  //     "pageLength": 50
  //   });

  // });

  // G·∫Øn ID v√†o n√∫t trong modal
  function sua(id) {
    // alert('B·∫°n ƒë√£ ch·ªçn c√¥ng vi·ªác v·ªõi ID: ' + id);
    openEditModal(id);
    $('#btnXoaCv').val(id);
  }

  // Xem chi ti·∫øt
  function xemchitiet(id) {
    window.location.href = '/congviec/chitiet?id=' + id;
  }

  // X√≥a c√¥ng vi·ªác
  $('#btnXoaCv').click(function () {
    const id = $(this).val();
    console.log('X√≥a c√¥ng vi·ªác v·ªõi ID:', id); 
    $.post(`/housetask/api/congviec/delete/`, { _id: id })
      .done(() => {
        // alert('‚úÖ ƒê√£ x√≥a c√¥ng vi·ªác!');
        location.reload();
      })
    .fail(() => alert('‚ùå L·ªói khi x√≥a c√¥ng vi·ªác.'));
  });
  
</script>
<script>
  // M·ªü modal s·ª≠a
  function openEditModal(id) {
    // G·ªçi API l·∫•y d·ªØ li·ªáu c√¥ng vi·ªác theo ID
    $.get(`/housetask/api/congviec/${id}`, function (res) {
      const cv = res.cv; // ‚úÖ l·∫•y object th·ª±c t·∫ø
      $('#idcv').val(cv._id);
      $('#edit_khuvuc').val(cv.khuvuc);
      $('#edit_vitri').val(cv.vitri);
      $('#edit_tencv').val(cv.tencv);
      $('#edit_congviectheothang').val(cv.congviectheothang);
      $('#edit_ngaybatdau').val(cv.ngaybatdau);
      $('#edit_ngayketthuc').val(cv.ngayketthuc);
      $('#edit_motacongviec').val(cv.motacongviec);
      $('#edit_solanlam').val(cv.solanlam);
      $('#edit_lichsucv').val(cv.lichsucv);
      $('#edit_thoigian').val(cv.thoigian);
      $('#edit_songaynhacthongbao').val(cv.songaynhacthongbao);
      $('#edit_preview_anh').attr('src', 'data:image/png;base64,' + (cv.maqrcochu ? cv.maqrcochu : '/img/logochudp.png')).show();
      $('#modalSuaCV').modal('show');
    });
  }

  // Submit form s·ª≠a
  $('#form-sua-cv').on('submit', function (e) {
      e.preventDefault();
      const formData = $(this).serialize();
      // console.log(formData);
      $.post(`/housetask/api/congviec/update`, formData)
        .done(() => {
          alert('‚úÖ C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng!');
          $('#modalSua').modal('hide');
          window.location.reload();
        })
        .fail(() => {
          alert('‚ùå L·ªói khi c·∫≠p nh·∫≠t c√¥ng vi·ªác!');
        });
  });
</script>
<style>
/* 1. ƒê·∫£m b·∫£o b·∫£ng kh√¥ng b·ªã tr√†n (quan tr·ªçng cho DataTables) */
.table-responsive {
    /* ƒê·∫∑t k√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh n·∫øu c·∫ßn ho·∫∑c ƒë·ªÉ DataTables qu·∫£n l√Ω */
    /* width: 100%; */ 
    overflow-x: auto; /* K√≠ch ho·∫°t thanh cu·ªôn ngang n·∫øu b·∫£ng qu√° r·ªông */
}

/* 2. Quy t·∫Øc quan tr·ªçng: √©p n·ªôi dung hi·ªÉn th·ªã tr√™n m·ªôt d√≤ng */
.table-bordered th, 
.table-bordered td {
    white-space: nowrap; /* B·∫Øt bu·ªôc n·ªôi dung kh√¥ng xu·ªëng d√≤ng */
    overflow: hidden;     /* ·∫®n n·ªôi dung b·ªã tr√†n ra ngo√†i */
    text-overflow: ellipsis; /* Hi·ªÉn th·ªã d·∫•u ba ch·∫•m cho n·ªôi dung b·ªã ·∫©n */
    max-width: 150px; /* ƒê·∫∑t chi·ªÅu r·ªông t·ªëi ƒëa cho c√°c c·ªôt (ƒëi·ªÅu ch·ªânh theo √Ω anh) */
}

/* 3. T·ªëi ∆∞u h√≥a chi·ªÅu r·ªông cho c√°c c·ªôt kh√¥ng c·∫ßn nhi·ªÅu ch·ªó */
/* V√≠ d·ª•: C·ªôt Thao t√°c v√† S·ªë l·∫ßn l√†m c√≥ th·ªÉ nh·ªè h∆°n */
.table-bordered th:nth-child(1),
.table-bordered td:nth-child(1) {
    max-width: 150px; /* TƒÉng l√™n 150px ƒë·ªÉ v·ª´a 3 n√∫t */
    width: 150px;
}

.table-bordered th:nth-child(8), /* S·ªë l·∫ßn l√†m */
.table-bordered td:nth-child(8),
.table-bordered th:nth-child(10), /* S·ªë ng√†y nh·∫Øc */
.table-bordered td:nth-child(10) {
    max-width: 70px; 
    width: 70px;
}
</style>